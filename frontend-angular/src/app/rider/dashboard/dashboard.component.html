<div class="container" [ngSwitch]="dashboardState">

    <!-- IDLE STATE: Request Form -->
    <mat-card *ngSwitchCase="'IDLE'">
        <mat-card-header>
            <mat-card-title>Request a Ride</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <form [formGroup]="rideForm" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Pickup Station</mat-label>
                    <mat-select formControlName="stationId">
                        <mat-option *ngFor="let station of stations" [value]="station.id">
                            {{ station.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Destination Area</mat-label>
                    <mat-select formControlName="destinationId">
                        <mat-option *ngFor="let area of destinations" [value]="area.id">
                            {{ area.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Number of Passengers</mat-label>
                    <mat-select formControlName="partySize">
                        <mat-option [value]="1">1</mat-option>
                        <mat-option [value]="2">2</mat-option>
                        <mat-option [value]="3">3</mat-option>
                        <mat-option [value]="4">4</mat-option>
                    </mat-select>
                </mat-form-field>

                <div class="offset-slider">
                    <label>Arrival Time Offset (Minutes): {{ rideForm.get('offsetMinutes')?.value }}</label>
                    <input type="range" min="0" max="30" step="5" formControlName="offsetMinutes">
                </div>

                <button mat-raised-button color="primary" type="submit" [disabled]="rideForm.invalid || loading">
                    {{ loading ? 'Requesting...' : 'Request Ride' }}
                </button>
            </form>
        </mat-card-content>
    </mat-card>

    <!-- PENDING STATE: Waiting Screen -->
    <mat-card *ngSwitchCase="'PENDING'" class="pending-card">
        <mat-card-content class="center-content">
            <mat-spinner diameter="50"></mat-spinner>
            <h2>Finding your driver...</h2>
            <p>Please wait while we match you with a nearby driver.</p>
            <button mat-stroked-button color="warn" (click)="cancelRequest()">Cancel Request</button>
        </mat-card-content>
    </mat-card>

    <!-- TRIP STATE: Active Trip -->
    <mat-card *ngSwitchCase="'TRIP'" class="trip-card">
        <mat-card-header>
            <mat-card-title>Trip #{{ activeTrip?.tripId }}</mat-card-title>
            <mat-card-subtitle>Status: {{ activeTrip?.status }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div *ngIf="activeTrip" class="trip-info">
                <h3>Trip #{{ activeTrip.tripId }}</h3>
                <p class="status">Status: {{ activeTrip.status }}</p>
                <p><strong>Route:</strong> {{ getAreaName(activeTrip.stationAreaId) }} to {{
                    getAreaName(activeTrip.destinationAreaId) }}</p>

                <div *ngIf="activeTrip.status === 'SCHEDULED' || activeTrip.status === 'CREATED'">
                    <button mat-stroked-button color="warn" (click)="cancelRequest()">Cancel Ride</button>
                </div>

                <div *ngIf="driverProfile" class="driver-details">
                    <h4>Driver & Vehicle</h4>
                    <p><strong>Name:</strong> {{ driverName || 'Loading...' }}</p>
                    <p><strong>Vehicle:</strong> {{ driverProfile.color }} {{ driverProfile.model }}</p>
                    <p><strong>Plate:</strong> {{ driverProfile.vehicleNo }}</p>
                    <p><strong>Capacity:</strong> {{ driverProfile.capacity }} seats</p>
                </div>
                <div *ngIf="!driverProfile">
                    <p><strong>Driver ID:</strong> {{ activeTrip.driverId }}</p>
                    <p><em>Loading driver details...</em></p>
                </div>

                <div *ngIf="driverLocation" class="location-info">
                    <h4>Current Location</h4>
                    <p>Area: {{ getAreaName(driverLocation.currentAreaId) }}</p>
                    <p>Occupancy: {{ driverLocation.occupancy }} / {{ driverProfile?.capacity || '?' }}</p>
                    <p class="timestamp">Last Update: {{ driverLocation.ts | date:'mediumTime' }}
                    </p>
                </div>
                <div *ngIf="!driverLocation">
                    <p><i>Fetching driver location...</i></p>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
</div>